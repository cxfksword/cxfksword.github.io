<!doctype html><html><head><meta charset=utf-8><title>ip &#183; cxfksword's notes</title><link rel=icon href=http://blog.tri-lib.com/favicon.ico type=image/x-icon><link rel=canonical href=http://blog.tri-lib.com/tags/ip/><link href=http://blog.tri-lib.com/tags/ip/index.xml rel=alternate type=application/rss+xml title=ip><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css><link rel=stylesheet href=http://blog.tri-lib.com/css/styles.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class=navbar><ul><li><a href=http://blog.tri-lib.com/>HOME</a></li><li><a href=http://blog.tri-lib.com/categories>CATEGORIES</a></li><li><a href=http://blog.tri-lib.com/tags>TAGS</a></li><li><a href=http://blog.tri-lib.com/about class=logo-title>ABOUT</a></li></ul></div><div class=container><div class=title><a href=http://blog.tri-lib.com/><img src=http://blog.tri-lib.com/images/logo.png width=260px height=48px></a></div><a href=http://blog.tri-lib.com/2012/01/get-client-ip/><div class=post-title><img src=http://blog.tri-lib.com/images/post-title-icon.png><div class=post-meta><time>09 Jan 2012, 07:39</time><h1>获取客户端的真实ip代码改进</h1></div></div></a><div class=summary-content><p>现在系统中常用的获取客户端真实ip的代码如下：</p><pre><code>// 获取IP地址
protected string GetIPAddress()
{
    string result = &quot;&quot;;
    try
    {
        //透过代理取客户端ip
        result = HttpContext.Current.Request.ServerVariables[&quot;HTTP_X_FORWARDED_FOR&quot;] ?? &quot;&quot;;
        if (result == &quot;&quot;)
        {
            //连接主机ip
            result = HttpContext.Current.Request.ServerVariables[&quot;REMOTE_ADDR&quot;] ?? &quot;&quot;;
        }
        if (result == &quot;&quot;)
        {
            result = HttpContext.Current.Request.UserHostAddress;
        }
    }
    catch (Exception ex)
    {
    }
    return result;
}
</code></pre><p>这段代码有两个问题：
1、根据<a href=http://www.openinfo.co.uk/apache/index.html>这篇文章</a>说明，当请求经常多个代理时，HTTP_X_FORWARDED_FOR可能会附加上多个服务器ip，格式如下：</p><a href=http://blog.tri-lib.com/2012/01/get-client-ip/ class=summary-more>READ MORE</a></div><hr class=summary-sep><a href=http://blog.tri-lib.com/2012/01/crawl-sina-ip-data/><div class=post-title><img src=http://blog.tri-lib.com/images/post-title-icon.png><div class=post-meta><time>09 Jan 2012, 07:23</time><h1>通过新浪接口抓取ip库</h1></div></div></a><div class=summary-content><p>新浪有开放ip查询的接口（<a href="http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=json&ip=123.124.2.85">http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=json&ip=123.124.2.85</a>），通过不断查询就能抓取到ip信息。不过要遍历所有的ip地址不现实，数据存储和查询都是问题，一般我们面对的是中国的用户，只需要遍历抓取下中国范围的ip信息就行，而且ip地址最后一位的256个ip一般分配到同一地区，所以最后一位只需遍历.0的ip就可以了。
目前ip4地址已经分配完，中国的ip段可以在以下网址找到：
<a href=https://www.countryipblocks.net/e_country_data/CN_range.txt>https://www.countryipblocks.net/e_country_data/CN_range.txt</a>
首先需要处理，把上面的ip段转换为具体的ip地址：</p><a href=http://blog.tri-lib.com/2012/01/crawl-sina-ip-data/ class=summary-more>READ MORE</a></div><hr class=summary-sep><a href=http://blog.tri-lib.com/2011/12/ip-lookup/><div class=post-title><img src=http://blog.tri-lib.com/images/post-title-icon.png><div class=post-meta><time>25 Dec 2011, 06:09</time><h1>门户网站的ip查询接口</h1></div></div></a><div class=summary-content><p>腾讯：<a href="http://ip.qq.com/cgi-bin/searchip?searchip1=121.236.225.37">http://ip.qq.com/cgi-bin/searchip?searchip1=121.236.225.37</a>
现在只能通过解析页面内容到取得</p><p>新浪：<a href="http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=json&ip=123.124.2.85">http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=json&ip=123.124.2.85</a></p><p>网易： <a href="http://www.youdao.com/smartresult-xml/search.s?type=ip&q=123.124.2.85">http://www.youdao.com/smartresult-xml/search.s?type=ip&q=123.124.2.85</a></p><p>ip地址在各个国家的分配情况表：
<a href=http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest>http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest</a>
<a href=http://www.countryipblocks.net/country-blocks/ip-range-format/>http://www.countryipblocks.net/country-blocks/ip-range-format/</a></p></div><hr class=summary-sep><div class=paging>PAGE 1 / 1</div><footer class=footer>COPYRIGHT (C) <a href=https://blog.lulab.net>DONGGEUN,BANG</a>. ALL RIGHTS RESERVED.<p>Hosted by <a href=https://pages.coding.me style=font-weight:700>Coding Pages</a></p></footer></body></html>