<!doctype html><html><head><meta charset=utf-8><title>如何查看哪些进程和服务器正在使用数据库 &#183; cxfksword's notes</title><link rel=icon href=http://blog.tri-lib.com/favicon.ico type=image/x-icon><link rel=canonical href=http://blog.tri-lib.com/2012/03/find-who-connect-to-database/><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css><link rel=stylesheet href=http://blog.tri-lib.com/css/styles.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class=navbar><ul><li><a href=http://blog.tri-lib.com/>HOME</a></li><li><a href=http://blog.tri-lib.com/categories>CATEGORIES</a></li><li><a href=http://blog.tri-lib.com/tags>TAGS</a></li><li><a href=http://blog.tri-lib.com/about class=logo-title>ABOUT</a></li></ul></div><div class=container><div class=title><a href=http://blog.tri-lib.com/><img src=http://blog.tri-lib.com/images/logo.png width=260px height=48px></a></div><a href=http://blog.tri-lib.com/2012/03/find-who-connect-to-database/><div class=post-title><img src=http://blog.tri-lib.com/images/post-title-icon.png><div class=post-meta><time>17 Mar 2012, 09:33</time><h1>如何查看哪些进程和服务器正在使用数据库</h1></div></div></a><div class=post-toc><span class=title>Table of contents</span><nav id=TableOfContents><ul><li><ul><li><a href=#1sql-serverid>1、查看Sql Server进程ID</a></li><li><a href=#2sql-server>2、查看当前连接Sql Server的服务器列表</a></li><li><a href=#3>3、查看连接到数据库服务器的进程</a></li><li><a href=#4iis>4、查看IIS进程对应的站点</a></li></ul></li></ul></nav></div><section class=post-content><p>工作中有时会碰到需要迁移数据库的时候，如更换机房，更换新服务器等。迁移数据库最重要是要确保正在运行的程序不会因为漏更改连接字符串而导致程序报错。但有时维护的项目可能老旧，没有相关维护文档，还有一些使用该数据库的windows服务也可能遍布在其他服务器上，这时我们该如何找到所有正在使用该数据库的服务呢？</p><p>下面以windows服务器和Sql Server数据库为例，数据库服务器的ip是192.168.6.189，linux平台的思路差不多，只是命令有变化。</p><h3 id=1sql-serverid>1、查看Sql Server进程ID</h3><p>打开任务管理器，点击“<strong>查看</strong>-><strong>选择列</strong>”，勾选“<strong>PID(进程标识符)</strong>”
<img src=http://ww1.sinaimg.cn/large/7ce4a9f6gw1e5q1p9zo5yj20b70bkabs.jpg alt="sql server">
<img src=http://ww4.sinaimg.cn/large/7ce4a9f6gw1e5q1pyu9epj205k07ywf2.jpg alt="sql server"></p><p>进程名称为“<strong>sqlservr.exe</strong>”的PID就是Sql Server的进程ID，当前是<strong>1800</strong>。</p><h3 id=2sql-server>2、查看当前连接Sql Server的服务器列表</h3><p>打开命令行，输入下面的命令：</p><pre><code>netstat -ano|find &quot;1800&quot;
</code></pre><p>结果如下：</p><pre><code>C:\Documents and Settings&gt;netstat -ano|find &quot;1800&quot;
  TCP    0.0.0.0:3758           0.0.0.0:0              LISTENING       1800
  TCP    0.0.0.0:5025           0.0.0.0:0              LISTENING       1800
  TCP    127.0.0.1:1434         0.0.0.0:0              LISTENING       1800
  TCP    192.168.6.189:3758     192.168.6.76:2685      ESTABLISHED     1800
  TCP    192.168.6.189:3758     192.168.6.76:2725      ESTABLISHED     1800
</code></pre><p>该命令会打印出所有连接到1800进程的服务器列表，可以看到<strong>192.168.6.76</strong>这台服务器正在连接到Sql Server。</p><h3 id=3>3、查看连接到数据库服务器的进程</h3><p>进入服务器192.168.6.76，打开命令行，输入下面的命令：</p><pre><code>netstat -ano |find &quot;6.189&quot;
</code></pre><p>6.189是数据库服务器的ip，find命令用来查找带有"6.189"字符串的行。输出如下：</p><pre><code>d:\webroot&gt;netstat -ano |find &quot;6.189&quot;
  TCP    192.168.6.76:2685      192.168.6.189:3758     ESTABLISHED     8520
  TCP    192.168.6.76:2725      192.168.6.189:3758     ESTABLISHED     8520
</code></pre><p>结果最右边的就是正连接到数据库服务器的进程ID，当前是<strong>8520</strong>.现在已经找到进程了^0^，你只需打开任务管理器，看下该进程ID对应是进程是什么，就能准确定位了。</p><h3 id=4iis>4、查看IIS进程对应的站点</h3><p>有时我们找到使用数据库的进程了，但是像IIS这种程序，因为所有站点的进程名都相同，所以无法准备定位了。
<img src=http://ww3.sinaimg.cn/large/7ce4a9f6gw1e5q1qewrroj206s08iaal.jpg alt="sql server">
有什么方法可以找到w3wp.exe对应的站点名呢？可以使用iisapp命令：</p><pre><code>d:\webroot&gt;iisapp -a
W3WP.exe PID: 6584   AppPoolId: test1.com
W3WP.exe PID: 16304   AppPoolId: Special
W3WP.exe PID: 8520   AppPoolId: test2.com
W3WP.exe PID: 3164   AppPoolId: test3.com
</code></pre><p>iisapp命令会输出W3WP进程对应的应用程序池名，通过应用程序池名我们就能准备定位站点：）</p></section><div class=share><a href="http://www.facebook.com/sharer.php?src=bm&u=http%3a%2f%2fblog.tri-lib.com%2f2012%2f03%2ffind-who-connect-to-database%2f&t=%e5%a6%82%e4%bd%95%e6%9f%a5%e7%9c%8b%e5%93%aa%e4%ba%9b%e8%bf%9b%e7%a8%8b%e5%92%8c%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%ad%a3%e5%9c%a8%e4%bd%bf%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93" onclick="window.open(this.href,'PCwindow','width=550, height=350, menubar=no, toolbar=no, scrollbars=yes');return false;"><i class="fa fa-facebook"></i></a><a href="http://twitter.com/intent/tweet?url=http%3a%2f%2fblog.tri-lib.com%2f2012%2f03%2ffind-who-connect-to-database%2f&text=%e5%a6%82%e4%bd%95%e6%9f%a5%e7%9c%8b%e5%93%aa%e4%ba%9b%e8%bf%9b%e7%a8%8b%e5%92%8c%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%ad%a3%e5%9c%a8%e4%bd%bf%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93&tw_p=tweetbutton" onclick="window.open(this.href,'PCwindow','width=550, height=350, menubar=no, toolbar=no, scrollbars=yes');return false;"><i class="fa fa-twitter"></i></a><a href="https://plus.google.com/share?url=http%3a%2f%2fblog.tri-lib.com%2f2012%2f03%2ffind-who-connect-to-database%2f" onclick="window.open(this.href,'PCwindow','width=550, height=350, menubar=no, toolbar=no, scrollbars=yes');return false;"><i class="fa fa-google-plus"></i></a><a href="http://getpocket.com/edit?url=http%3a%2f%2fblog.tri-lib.com%2f2012%2f03%2ffind-who-connect-to-database%2f&title=%e5%a6%82%e4%bd%95%e6%9f%a5%e7%9c%8b%e5%93%aa%e4%ba%9b%e8%bf%9b%e7%a8%8b%e5%92%8c%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%ad%a3%e5%9c%a8%e4%bd%bf%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93" onclick="window.open(this.href,'PCwindow','width=550, height=350, menubar=no, toolbar=no, scrollbars=yes');return false;"><i class="fa fa-get-pocket"></i></a></div><div class=post-meta-code><div class=desc>public string description() {<div class=desc>val author = "
cxfksword
";</div><div class=desc>val categories = [
<a href=http://blog.tri-lib.com/categories/%E6%8A%80%E6%9C%AF>"技术"</a>
];</div>}</div><div class=desc>public string tags() {<div class=desc>val tags = [
<a href=http://blog.tri-lib.comtags/sqlserver>"SqlServer"</a>
];</div>}</div></div><div class=post-comment></div><div class="paging post-paging"><a class=left href=http://blog.tri-lib.com/2012/03/understanding-iis-host-headers/ rel=prev><i class="fa fa-caret-left" aria-hidden=true></i><span>了解IIS的主机名(Host Headers)配置项</span></a>
<a class=right href=http://blog.tri-lib.com/2012/03/linux-useful-commands/ rel=next><span>linux常用命令</span> <i class="fa fa-caret-right" aria-hidden=true></i></a></div><footer class=footer>COPYRIGHT (C) <a href=https://blog.lulab.net>DONGGEUN,BANG</a>. ALL RIGHTS RESERVED.<p>Hosted by <a href=https://pages.coding.me style=font-weight:700>Coding Pages</a></p></footer></body></html>