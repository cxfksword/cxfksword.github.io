<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="近排开发的一个后台系统（域名：admin.test.test.com）在接入公司统一SSO时，遇到了cookie冲突引起的登录循环重定向的bug。
公司有一个统一的SSO登录页面，我们开发的系统是跳转到该页面实现登录验证的。有用户反映登录不了，浏览器提示循环重定向了，查看用户浏览器发现有两个相同名称的session cookie：
PHPSESSID=token1; path=/; expired=/; domain=.test.com PHPSESSID=token2; path=/; expired=/; domain=.test.test.com 显然这两个cookie的domain因为都是admin.test.test.com的根域名，使浏览器都发送到php后台系统了。第一个是后台系统（admin.test.test.com）写入的，是正确的session id，而第二个是由未知系统写入的。测试打印**$_COOKIE[&amp;lsquo;PHPSESSID&amp;rsquo;]**发现输出是：
token2 很明显php读取到了错误的session id，所以导致系统读取不到保存在session中的登录信息，而误判用户为未登录，之后再把用户跳转回SSO登录页面，跳转回SSO系统后，SSO系统知道用户已登录过，再跳转回系统。。。这样就一直循环下去了=。="><title>解决cookie冲突导致的登录循环重定向</title><link rel=canonical href=//blog.tri-lib.com/2015/04/loop-redirect-cause-by-cookie-conflict/><link rel=stylesheet href=//blog.tri-lib.com/scss/style.min.css><meta property="og:title" content="解决cookie冲突导致的登录循环重定向"><meta property="og:description" content="近排开发的一个后台系统（域名：admin.test.test.com）在接入公司统一SSO时，遇到了cookie冲突引起的登录循环重定向的bug。
公司有一个统一的SSO登录页面，我们开发的系统是跳转到该页面实现登录验证的。有用户反映登录不了，浏览器提示循环重定向了，查看用户浏览器发现有两个相同名称的session cookie：
PHPSESSID=token1; path=/; expired=/; domain=.test.com PHPSESSID=token2; path=/; expired=/; domain=.test.test.com 显然这两个cookie的domain因为都是admin.test.test.com的根域名，使浏览器都发送到php后台系统了。第一个是后台系统（admin.test.test.com）写入的，是正确的session id，而第二个是由未知系统写入的。测试打印**$_COOKIE[&amp;lsquo;PHPSESSID&amp;rsquo;]**发现输出是：
token2 很明显php读取到了错误的session id，所以导致系统读取不到保存在session中的登录信息，而误判用户为未登录，之后再把用户跳转回SSO登录页面，跳转回SSO系统后，SSO系统知道用户已登录过，再跳转回系统。。。这样就一直循环下去了=。="><meta property="og:url" content="//blog.tri-lib.com/2015/04/loop-redirect-cause-by-cookie-conflict/"><meta property="og:site_name" content="cxfksword's notes"><meta property="og:type" content="article"><meta name=twitter:title content="解决cookie冲突导致的登录循环重定向"><meta name=twitter:description content="近排开发的一个后台系统（域名：admin.test.test.com）在接入公司统一SSO时，遇到了cookie冲突引起的登录循环重定向的bug。
公司有一个统一的SSO登录页面，我们开发的系统是跳转到该页面实现登录验证的。有用户反映登录不了，浏览器提示循环重定向了，查看用户浏览器发现有两个相同名称的session cookie：
PHPSESSID=token1; path=/; expired=/; domain=.test.com PHPSESSID=token2; path=/; expired=/; domain=.test.test.com 显然这两个cookie的domain因为都是admin.test.test.com的根域名，使浏览器都发送到php后台系统了。第一个是后台系统（admin.test.test.com）写入的，是正确的session id，而第二个是由未知系统写入的。测试打印**$_COOKIE[&amp;lsquo;PHPSESSID&amp;rsquo;]**发现输出是：
token2 很明显php读取到了错误的session id，所以导致系统读取不到保存在session中的登录信息，而误判用户为未登录，之后再把用户跳转回SSO登录页面，跳转回SSO系统后，SSO系统知道用户已登录过，再跳转回系统。。。这样就一直循环下去了=。="><meta property="article:section" content="Post"><meta property="article:tag" content="php"><meta property="article:tag" content="http"><meta property="article:published_time" content="2015-04-02T00:21:00+00:00"><meta property="article:modified_time" content="2015-04-02T00:21:00+00:00"><link rel=icon type=image/png href=//blog.tri-lib.com/img/favicon_hucaec59626a4b072e0484c02c0d7451cf_2387_32x0_resize_box_2.png><style>.article-page article .article-content img{max-width:720px}.article-summary-more{margin-left:5px;padding:1px 5px;border-radius:5px;border:var(--card-text-color-secondary)solid 1px;color:var(--card-text-color-secondary);font-size:.8em}</style></head><body><div id=content><div class="container extended flex on-phone--column align-items--flex-start article-page with-toolbar"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=//blog.tri-lib.com/img/avatar_hub76bbbc8c06c72418eefeedfe902e916_30687_300x300_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
<span class=emoji>🍥</span></figure><h1 class=site-name><a href=//blog.tri-lib.com/>cxfksword's notes</a></h1><h2 class=site-description>simple thinking, simple life.</h2></header><nav class=menu id=main-menu><li><a href=//blog.tri-lib.com/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>首页</span></a></li><li><a href=//blog.tri-lib.com/archive/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>归档</span></a></li><li><a href=//blog.tri-lib.com/projects><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg><span>项目</span></a></li><li><a href=//blog.tri-lib.com/abouts><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>关于</span></a></li><li><a href=//blog.tri-lib.com/index.xml><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg><span>订阅</span></a></li></nav></aside><div class="flex column do-not-overflow full-width"><main class=main><div id=article-toolbar><a href=//blog.tri-lib.com/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=//blog.tri-lib.com/categories/%E6%8A%80%E6%9C%AF>技术</a></header><h2 class=article-title><a href=//blog.tri-lib.com/2015/04/loop-redirect-cause-by-cookie-conflict/>解决cookie冲突导致的登录循环重定向</a></h2><footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>Apr 02, 2015</time></footer></div></header><section class=article-content><p>近排开发的一个后台系统（域名：admin.test.test.com）在接入公司统一SSO时，遇到了cookie冲突引起的登录循环重定向的bug。</p><p>公司有一个统一的SSO登录页面，我们开发的系统是跳转到该页面实现登录验证的。有用户反映登录不了，浏览器提示循环重定向了，查看用户浏览器发现有两个相同名称的session cookie：</p><pre><code>PHPSESSID=token1; path=/; expired=/; domain=.test.com  
PHPSESSID=token2; path=/; expired=/; domain=.test.test.com
</code></pre><p>显然这两个cookie的domain因为都是admin.test.test.com的根域名，使浏览器都发送到php后台系统了。第一个是后台系统（admin.test.test.com）写入的，是正确的session id，而第二个是由未知系统写入的。测试打印**$_COOKIE[&lsquo;PHPSESSID&rsquo;]**发现输出是：</p><pre><code>token2
</code></pre><p>很明显php读取到了错误的session id，所以导致系统读取不到保存在session中的登录信息，而误判用户为未登录，之后再把用户跳转回SSO登录页面，跳转回SSO系统后，SSO系统知道用户已登录过，再跳转回系统。。。这样就一直循环下去了=。=</p><p>为什么PHP会读取到错误的session id呢？打印全局变量**$_SERVER[&lsquo;HTTP_COOKIES&rsquo;]**出来查看：</p><pre><code>PHPSESSID=token2;PHPSESSID=token1
</code></pre><p>发现PHP是能接收到两个同名COOKIE的，但只取了第一个当真正的session id！！<br>查看php源码，在文件php_variables.c的220行，有注释出php对同名cookie的处理规则：</p><blockquote><p><a href=https://github.com/php/php-src/blob/e10e151e9b92313a7085272c85bebf6c82017fce/main/php_variables.c>https://github.com/php/php-src/blob/e10e151e9b92313a7085272c85bebf6c82017fce/main/php_variables.c</a> #220</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>    <span style=color:#75715e>/*
</span><span style=color:#75715e>     * According to rfc2965, more specific paths are listed above the less specific ones.
</span><span style=color:#75715e>     * If we encounter a duplicate cookie name, we should skip it, since it is not possible
</span><span style=color:#75715e>     * to have the same (plain text) cookie name for the same path and we should not overwrite
</span><span style=color:#75715e>     * more specific cookies with the less specific ones.
</span><span style=color:#75715e>     */</span>
    <span style=color:#66d9ef>if</span> (Z_TYPE(PG(http_globals)[TRACK_VARS_COOKIE]) <span style=color:#f92672>!=</span> IS_UNDEF <span style=color:#f92672>&amp;&amp;</span>
    	symtable1 <span style=color:#f92672>==</span> Z_ARRVAL(PG(http_globals)[TRACK_VARS_COOKIE]) <span style=color:#f92672>&amp;&amp;</span>
    	zend_symtable_str_exists(symtable1, index, index_len)) {
    	zval_ptr_dtor(<span style=color:#f92672>&amp;</span>gpc_element);
    } <span style=color:#66d9ef>else</span> {
    	gpc_element_p <span style=color:#f92672>=</span> zend_symtable_str_update_ind(symtable1, index, index_len, <span style=color:#f92672>&amp;</span>gpc_element);
    }
</code></pre></div><p>意思是当php遇到相同名称的cookie时，只会保留**$_SERVER[&lsquo;HTTP_COOKIES&rsquo;]**中的第一个cookie，而余下同名的会忽略跳过。</p><p>很明显，只要浏览器传cookie给php时，把token1的session id放在最前面，这样就能正确判断登录成功了！
那么浏览器传递cookie顺序是如何的呢？参考<a class=link href=http://www.rfc-editor.org/rfc/rfc6265.txt target=_blank rel=noopener>RFC6265 HTTP State Management Mechanism</a>，可以发现：</p><pre><code>4.2.2

   In particular,if the Cookie header contains two cookies with the same name (e.g.,
   that were set with different Path or Domain attributes), servers
   SHOULD NOT rely upon the order in which these cookies appear in the
   header.
5.3.  Storage Model

  2.  The user agent SHOULD sort the cookie-list in the following
       order:

       *  Cookies with longer paths are listed before cookies with
          shorter paths.

       *  Among cookies that have equal-length path fields, cookies with
          earlier creation-times are listed before cookies with later
          creation-times.

       NOTE: Not all user agents sort the cookie-list in this order, but
       this order reflects common practice when this document was
       written, and, historically, there have been servers that
       (erroneously) depended on this order.
</code></pre><p>大概意思就是：</p><ol><li>path越长的说明匹配越精确，顺序越靠前</li><li>假如path相同，cookie创建时间越早的，顺序越靠前</li><li>顺序与domain没关系<br>RFC同时也说明并不是所有的浏览器都遵守这个，并且服务器也不应该依赖于cookie出现的顺序。</li></ol><p>最后通过更改保存的session id名称来避免冲突解决问题，不过倒让我加深了cookie的了解。</p></section><footer class=article-footer><section class=article-tags><a href=//blog.tri-lib.com/tags/php>Php</a>
<a href=//blog.tri-lib.com/tags/http>Http</a></section></footer></article><aside class="widget related-contents--wrapper"><h1 class=widget-title></h1><div class=related-contents><div class="flex article-list--tile"><article><a href=//blog.tri-lib.com/2013/11/install-php-from-source-in-ubuntu/><div class=article-details><h2 class=article-title>在ubuntu中编译安装php</h2></div></a></article><article><a href=//blog.tri-lib.com/2013/11/handle-fatal-error-in-php/><div class=article-details><h2 class=article-title>捕捉php中的fatal error错误</h2></div></a></article><article><a href=//blog.tri-lib.com/abouts/><div class=article-details><h2 class=article-title>关于</h2></div></a></article><article><a href=//blog.tri-lib.com/star/><div class=article-details><h2 class=article-title>Github收藏开源项目</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy; 2020 cxfksword's notes</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank>Stack</a></b> designed by
<a href=https://jimmycai.com target=_blank>Jimmy</a></section></footer></main></div></div><div class=pswp tabindex=-1 role=dialog aria-hidden=true style=display:none><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=//blog.tri-lib.com/ts/main.js defer></script><script>(function(){const customFont=document.createElement('link');customFont.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";customFont.type="text/css";customFont.rel="stylesheet";document.head.appendChild(customFont);}());</script></body></html>